# Set up Amplify Auth

In this guide, you will learn how to set up Amplify Authentication. This job includes setting up and connecting your backend resources, determining your auth implementation and integration path, and enabling sign-up, sign-in, and sign-out. We will also provide more context on how resources are managed and created with Amplify to help you make decisions and understand any long-term impact of those decisions for your use case. If you are new to Amplify Authentication, you can get a [high-level overview](https://aws.amazon.com/amplify/authentication/) of the features before getting started.

## Set up and connect to backend resources

In this job you will set up and connect to your backend resources. This job includes understanding how resources are managed and created to help you choose a management path. We will review the  features and functionality available with Amplify as well as how Cognito is used with Amplify. We will also look at how your security strategy and password formats may influence some of your choices for this job. 

> **Before you begin, you will need:**
> - [Amplify CLI installed](https://docs.amplify.aws/cli/start/install/)
> - [Node.js](https://nodejs.org/) v14.x or later
> - [npm](https://www.npmjs.com/) v6.14.4 or later
> - [git](https://git-scm.com/) v2.14.1 or later

[comment]: # (Links for node, npm, and git above from https://github.com/aws-amplify/docs/blob/main/src/fragments/start/getting-started/common/prereq.mdx; but we will need to update these fragments to use them as broader in scope than what we need here.)

[note]: # (In our workshop we called out that they may experience problems setting up the CLI but I did not put that section here b/c it read like it should be part of the CLI instructions. If this troubleshooting is specific to Auth let’s look at adding in an Expander here.)

### Choose your management path

[comment]: # (This section includes an updated overview that helps the user to decide which management method to use. This includes an explanation of how resources are managed and created; the benefits of using Amplify CLI and Studio to get Amplify features and functionality; how Cognito is used today; security strategy choices; and password formats. . This content should help them understand required decisions for the job before they get started on the actions. Current content from - https://github.com/aws-amplify/docs/blob/main/src/fragments/lib/auth/js/getting-started.mdx Additional INSPIRATION from https://docs.amplify.aws/lib/auth/overview/q/platform/js/ and https://docs.amplify.aws/cli/auth/overview/)

You can create and manage your Authentication resources with Amplify by using the Amplify CLI, Amplify Studio, or Amplify Libraries. The most common way is via the Amplify CLI, which allows you to create new Amazon Cognito resources or import existing ones. However, you can also use the Amplify Studio console to configure authentication or use the `Amplify.configure()` method to set up authentication with existing resources via the Amplify Libraries. 

We recommend using Amplify CLI or Amplify Studio when creating and deploying your Authentication resources (Cognito user pools, IAM roles, etc.) as these tools will help you with resource provisioning, IAM policies and roles for resources, deployments, local testing, continuous integration and deployment (CI/CD), and environment management. Studio also includes the added benefit of collaboration across your team with other developers. 

Amplify Libraries can be used to integrate your existing Authentication resources into your app code but this is limited to interacting with provisioned resources individually and is better suited for basic prototyping and small projects.

#### What is your security strategy?

[comment]: # (EXPANDER section that provides a foundational look at security strategies and how Amplify aligns to those choices. We had put this as a need-to-know initially so once written we may consider if this should be taken out of the expander. Content from https://github.com/aws-amplify/docs/blob/main/src/fragments/lib/auth/js/overview.mdx and INSPIRATION from  https://docs.amplify.aws/lib/auth/getting-started/q/platform/js/ , https://docs.amplify.aws/lib/auth/overview/q/platform/js/ , https://docs.amplify.aws/lib/auth/mfa/q/platform/js/ )

Amplify Authentication helps you secure your application while providing an easy sign-in experience for your users. This experience will be influenced by your security strategy. This security strategy will include both the authentication method as well as security credentials and enabling additional verification when needed.

> - *Authentication* is a process to validate **who you are** (abbreviated as *AuthN*). The system which does this validation is referred to as an **Identity Provider** or **IdP**. This can be your own self-hosted IdP or a cloud service. Oftentimes, this IdP is a social provider such as Facebook, Google, or Amazon.
> - *Authorization* is the process of validating **what you can access** (abbreviated as *AuthZ*). This is sometimes done by looking at tokens with custom logic, predefined rules, or signed requests with policies.

Common authentication methods and associated risks include: 1) username/password which is simple to set up but prone to compromise, 2) social provider federation which shares data with third parties, and 3) multi-factor authentication which adds a layer of security at sign-in but also adds friction for your users.

In the Amplify ecosystem, the most common Authentication method is either using Amazon Cognito User Pools independently or with a social provider to validate the identity of the user (known as *Federation*). 

[Amazon Cognito User Pools](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html) is a full-featured user directory service to handle user registration, authentication, and account recovery. [Amazon Cognito Federated Identities or Identity Pools](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-identity.html) on the other hand, is a way to authorize your users to use AWS services.

Amplify interfaces with User Pools to store your user information, including federation with other OpenID providers like Facebook & Google, and it leverages Federated Identities to manage user access to AWS Resources, for example allowing a user to upload a file (to an S3 bucket). The Amplify CLI automates the access control policies for these AWS resources as well as provides [fine grained access controls via GraphQL](https://docs.amplify.aws/cli/graphql/authorization-rules) for protecting data in your APIs.

Authorization is often done in one of two ways:

1. Clients pass the tokens to the backend that perform custom logic to allow or deny actions
1. Clients sign the requests and the backend validates the signature, allowing or denying actions depending on predefined policy. The predefined rules are known as [IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html) policies and automatically configured by the Amplify CLI.

The first mode is a common authorization method for REST or GraphQL APIs, while the second mode is necessary for interfacing with AWS services such as S3, Pinpoint, and others.

You can improve security credentials and verification for these authentication methods by adding: 1) password policies that ensure stronger passwords created by your users, 2) require additional contact information from users before they can reset passwords, 3) limit sign-in attempts to prevent brute-force logins, and 4) enable temporary passwords for MFA flows to improve user verification.

Amplify allows you to start simple and build incremental security and customization over time as your needs evolve. These are just some of the decisions and best practices that you can incorporate into your authentication strategy with Amplify. 

[comment]: # (End of expander section.)

Amplify uses [Amazon Cognito](https://aws.amazon.com/cognito/) as the main authentication provider. Amazon Cognito is a robust user directory service that handles user registration, authentication, account recovery, and other operations. You will be able to work with Amazon Cognito with each of the management methods. If you have not worked with Amazon Cognito before we recommend taking a closer look at Amazon Cognito configuration decisions before you continue.

#### Understanding Amazon Cognito configuration decisions

[comment]: # (EXPANDER section that details decisions with Cognito that cannot change in the long-term such as: user attributes cannot be renamed or deleted; login methods - username/email/phone/alias - cannot be added or changed; standard attributes which are required cannot be changed; enabling MFA after it was disabled is not possible. INSPIRATION from https://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html I also used a few additional pages: https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-attributes.html and https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa.html)

Amazon Cognito can be customized based on your security strategy for authentication. However, there are some initial configuration options that cannot be changed after the domain is launched and the user pool put into use by your application:

- User attributes that are used to identify your individual users (e.g. username, email, etc.) cannot be renamed or deleted.
- Login methods (including username, email, phone, etc.) cannot be added or changed after the initial configuration. This includes both defining which attributes are used to log-in and which attributes are required. Required attributes must have a value for all users once set.
- Verification methods (including username, email, etc.) are the same as required attributes and cannot be removed once configured.
- The encryption setting is set once the user pool is launched and cannot be changed to encrypt/decrypt after that point.
- The ‘sub’ attribute is a unique identifier within each user pool that cannot be modified and can be used to index and search users.
- Disabling sign-up for your user pool cannot be re-enabled and users will no longer be able to create accounts. 
- MFA type (SMS, TOTP) is set if selected when the user pool is created and cannot be disabled or changed to an unsupported option (e.g. push notification) once it is enabled. Additionally, if MFA is set to required for all users or certain groups this requirement cannot be disabled later on.

See the [Amazon Cognito documentation]( https://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html) for more details on these settings including [User pool attributes](https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-attributes.html) and [Adding MFA to a user pool](https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-mfa.html).

[comment]: # (End of expander section.)

### Set up and configure your auth category

[comment]: # (Content consolidated so we can review as a whole and update as needed as a whole. Sources include: https://github.com/aws-amplify/docs/blob/main/src/fragments/lib/auth/js/getting_started/10_setUpBackendResources.mdx - note that in the section below it mentions installing CLI and libraries ahead of time. I took out the separate CTA to install Amplify libraries on the getting started page as this is also called out in the switchers directly – do we want to adjust how this is called out in the switchers? Currently a link.)

Once you have chosen your management method you can configure your auth category by installing the library and configuring the category. Choose your method to complete the set up and configuration:

#### Understanding password formats

[comment]: # (EXPANDER section that provides more information on password formats – length, characters, etc. INSPIRATION from https://docs.amplify.aws/lib/auth/manageusers/q/platform/js/ It looks like from the switchers that only Studio requires these decisions this early do we want to move this information to that switcher or do we need to update this for both “create” options?)

When you are setting up your password formats for authentication you will want to consider the following best practices:

- Password strength: You can set minimum length, character types, and prevent common words or sequences to help users make stronger passwords. This can include an expiration period to help your users update their password regularly (e.g. every 90 days). There are also options to limit repeated passwords by making sure it is no one of the previous X passwords. Finally, if you have MFA enabled, you can use temporary passwords to add more verification.
- Forgotten passwords: You have the option to require additional verified contact information (e.g. email, phone) or use a validation code in the reset flow. You can also track password resets in your logs (e.g AWS CloudTrail) to check for suspicious activity.
- Lockout settings: Set the number of incorrect sign-in attempts you allow within a specific time frame (min/hours) for you users. You can also check for unverified devices and require additional validation when your user’s device changes. 

[comment]: # (End of expander section.)

<BlockSwitcher>
<Block name="Amplify CLI (Create)">

> Prerequisites: [Install and configure](/lib/project-setup/prereq/q/platform/js/) the Amplify CLI in addition to the Amplify libraries and [necessary dependencies](/lib/auth/getting-started/q/platform/js/#install-amplify-libraries).

To start provisioning auth resources in the backend, go to your project directory and **execute the command**:

```bash
amplify add auth
```

```console
? Do you want to use the default authentication and security configuration? Default configuration
? How do you want users to be able to sign in? Username
? Do you want to configure advanced settings?  No, I am done.
```
> If you have previously enabled an Amplify category that uses Auth behind the scenes (e.g. API category), you can run the `amplify update auth` command to edit your configuration if needed. 

The CLI prompts will help you to customize your auth flow for your app. With the provided options, you can:
- Customize sign-in/registration flow 
- Customize email and SMS messages for Multi-Factor Authentication
- Customize attributes for your users, e.g. name, email
- Enable 3rd party social providers, e.g. Facebook, Twitter, Google and Amazon

If you wish to federate with social providers [you will need to configure them first](/lib/auth/social#social-providers-and-federation).

After configuring your Authentication options, update your backend and deploy the service by running the `push` command:

```bash
amplify push
```

Now, the authentication service has been deployed and you can start using it. To view the deployed services in your project at any time, go to Amplify Console by running the following command:

```bash
amplify console
```

In your app's entry point (i.e. **App.js**, **index.js**, **_app.js**, or **main.js**), import and load the configuration file:

```javascript
import { Amplify, Auth } from 'aws-amplify';
import awsconfig from './aws-exports';
Amplify.configure(awsconfig);
```

</Block>

<Block name="Amplify CLI (Import)">

> Prerequisites: [Install and configure](/lib/project-setup/prereq/q/platform/js/) the Amplify CLI in addition to the Amplify libraries and [necessary dependencies](/lib/auth/getting-started/q/platform/js/#install-amplify-libraries).

To import existing Amazon Cognito resources into your Amplify project, **execute the command**:

```bash
amplify import auth
```
```console
? What type of auth resource do you want to import?
   Cognito User Pool and Identity Pool
   Cognito User Pool only
```

Once you've selected an option, you'll be able to search for and import an existing Cognito User Pool and Identity Pool (or User Pool only) within your AWS account.  The `amplify import auth` command will also do the following:
- Automatically populate your Amplify Library configuration files (aws-exports.js, amplifyconfiguration.json) with your chosen Amazon Cognito resource information
- Provide your designated existing Cognito resource as the authentication & authorization mechanism for all auth-dependent categories (API, Storage and more)
- Enable Lambda functions to access the chosen Cognito resource if you permit it

> If you have previously enabled an Amplify category that uses Auth behind the scenes (e.g. API category), you can run the `amplify update auth` command to edit your configuration if needed. 

After configuring your Authentication options, update your backend and deploy the service by running the `push` command:

```bash
amplify push
```

Now, the authentication service has been deployed and you can start using it. To view the deployed services in your project at any time, go to Amplify Console by running the following command:

```bash
amplify console
```

In your app's entry point (i.e. **App.js**, **index.js**, **_app.js**, or **main.js**), import and load the configuration file:

```javascript
import { Amplify, Auth } from 'aws-amplify';
import awsconfig from './aws-exports';
Amplify.configure(awsconfig);
```

</Block>

<Block name="Amplify Studio"> 

> Prerequisites: [Install and configure](/lib/project-setup/prereq/q/platform/js/) the Amplify CLI in addition to the Amplify libraries and [necessary dependencies](/lib/auth/getting-started/q/platform/js/#install-amplify-libraries).

Amplify Studio allows you create auth resources, set up authorization rules, implement Multi-factor authentication (MFA), and more via an intuitive UI. To set up Authentication through the Amplify Studio, take the following steps: 

1. **Sign in** to the [AWS Management Console](https://console.aws.amazon.com/console/home) and open AWS Amplify.
2. In the navigation pane, **choose an application**.
3. On the application information page, choose the **Backend environments** tab, then choose **Launch Studio**.
4. On the **Set up** menu, choose **Authentication**.
5. In the **Configure log in** section, choose a login mechanism to add from the **Add login mechanism** list. Valid options are _Username_, _Phone number_, _Facebook_, _Google_, _Amazon_, and _Sign in with Apple_. If you choose one of the social sign-in mechanisms (i.e. _Facebook_, _Google_, _Amazon_, or _Sign in with Apple_), you will also need to enter your _App ID_, _App Secret_, and redirect URLs.
6. (Optional) Add multi-factor authentication (MFA). MFA is set to **Off** by default. To turn on MFA, do the following in the **Multi-factor authentication** section:
* Choose **Enforced** to require MFA for all users or choose **Optional** to allow individual users to enable MFA.
* (Optional) Choose **SMS**, and enter your SMS message.
* (Optional) Choose **Authenticator Application** if you want your app to load with an authentication flow that includes sign up and sign in.
7. In the **Configure sign up** section, expand **Password protection settings** and customize the password policy settings to enforce. u6. Choose **Save and Deploy**. This starts a CloudFormation deployment with the progress displayed in the upper right corner of the page.
8. After creating and configuring your auth resources, you'll need to pull them down from Amplify Studio.  To do so, simply click on "Local setup instructions" in the upper right hand corner of the Studio console and execute the CLI command it provides at the root directory of your app. 

> You can also [import](https://docs.amplify.aws/console/auth/import/) existing Amazon Cognito resources and [manage users and groups](https://docs.amplify.aws/console/auth/user-management/) through the Amplify Studio UI. 

</Block>

<Block name="Existing Resources">

Existing Authentication resources from AWS (e.g. Amazon Cognito UserPools or Identity Pools) can be used with the Amplify Libraries by calling the `Amplify.configure()` method. 

In your app's entry point (i.e. **App.js**, **index.js**, **_app.js**, or **main.js**), import and load the configuration file:

```javascript
import { Amplify, Auth } from 'aws-amplify';

Amplify.configure({
  Auth: {
    // REQUIRED only for Federated Authentication - Amazon Cognito Identity Pool ID
    identityPoolId: 'XX-XXXX-X:XXXXXXXX-XXXX-1234-abcd-1234567890ab',

    // REQUIRED - Amazon Cognito Region
    region: 'XX-XXXX-X',

    // OPTIONAL - Amazon Cognito Federated Identity Pool Region
    // Required only if it's different from Amazon Cognito Region
    identityPoolRegion: 'XX-XXXX-X',

    // OPTIONAL - Amazon Cognito User Pool ID
    userPoolId: 'XX-XXXX-X_abcd1234',

    // OPTIONAL - Amazon Cognito Web Client ID (26-char alphanumeric string)
    userPoolWebClientId: 'a1b2c3d4e5f6g7h8i9j0k1l2m3',

    // OPTIONAL - Enforce user authentication prior to accessing AWS resources or not
    mandatorySignIn: false,

    // OPTIONAL - This is used when autoSignIn is enabled for Auth.signUp
    // 'code' is used for Auth.confirmSignUp, 'link' is used for email link verification
    signUpVerificationMethod: 'code', // 'code' | 'link'

    // OPTIONAL - Configuration for cookie storage
    // Note: if the secure flag is set to true, then the cookie transmission requires a secure protocol
    cookieStorage: {
      // REQUIRED - Cookie domain (only required if cookieStorage is provided)
      domain: '.yourdomain.com',
      // OPTIONAL - Cookie path
      path: '/',
      // OPTIONAL - Cookie expiration in days
      expires: 365,
      // OPTIONAL - See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite
      sameSite: 'strict' | 'lax',
      // OPTIONAL - Cookie secure flag
      // Either true or false, indicating if the cookie transmission requires a secure protocol (https).
      secure: true,
    },

    // OPTIONAL - customized storage object
    storage: MyStorage,

    // OPTIONAL - Manually set the authentication flow type. Default is 'USER_SRP_AUTH'
    authenticationFlowType: 'USER_PASSWORD_AUTH',

    // OPTIONAL - Manually set key value pairs that can be passed to Cognito Lambda Triggers
    clientMetadata: {myCustomKey: 'myCustomValue'},

    // OPTIONAL - Hosted UI configuration
    oauth: {
      domain: 'your_cognito_domain',
      scope: [
        'phone',
        'email',
        'profile',
        'openid',
        'aws.cognito.signin.user.admin',
      ],
      redirectSignIn: 'http://localhost:3000/',
      redirectSignOut: 'http://localhost:3000/',
      responseType: 'code', // or 'token', note that REFRESH token will only be generated when the responseType is code
    },
  },
});


// You can get the current config object
const currentConfig = Auth.configure();
```
<Callout warning={true}>
If your existing UserPool client has a required attribute that is NOT set to mutable, you may face login issues when using Social sign in. To resolve this, you will need to <ExternalLink href="https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-settings-client-apps.html">create a new UserPool client</ExternalLink> and mark the required attribute as mutable.
</Callout>

#### OAuth configuration parameters:
These settings can be found in the Cognito User Pools console under **App Integration** section
- `domain`: This can be found in the **Domain name** sub section
- `scope`: Remember to have the scope allowed on the Cognito App client, this can be found on **App client settings** sub section
- `redirectSignIn`: URL must be present on **Callback URL(s)** , check on **App client settings** sub section
- `redirectSignOut`: URL must be present on **Sign out URL(s)**, check on **App client settings** sub section
- `responseType`: Option must be enabled on the App client, look for **Allowed OAuth Flows** on **App client settings** sub section. *Authorization code grant* is for 'code' value and *Implicit grant* is for 'token' value.

</Block>
</BlockSwitcher>

### Recap

You now have set up and configured your backend resources for Amplify authentication. 

[comment]: # (ADD TO RECAP a tie-in to real-world use and application of the topic discussed OR reiterate the benefit. If not applicable delete this comment.)

## Determine your Auth integration path

Before you implement Auth you will want to evaluate the options of using authenticator, Amplify Libraries, or Hosted UI for your use case. We recommend using authenticator as the easiest to implement. You can also use authenticator with Amplify Libraries to extend capabilities when needed.

> **Before you begin, you will need:**
> - Set up and connected backend resources with a configured Auth category

[Comment]: # (This whole section was marked to be expanded in our workshop – this section needs better detail. INSPIRATION below does not have accurate links but some digging did provide https://docs.amplify.aws/start/getting-started/auth/q/integration/react-native/#create-login-ui and https://docs.amplify.aws/start/getting-started/auth/q/integration/react/#create-login-ui and https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-app-integration.html#cognito-user-pools-app-integration-amplify and https://aws.amazon.com/blogs/security/use-the-hosted-ui-or-create-a-custom-ui-in-amazon-cognito/ )

### Compare implementation options

There are a few options to implement Auth depending on how much customization you will need:

- **Authenticator** is a full featured open-source drop-in UI component for authentication that allows you to quickly add a production-ready authentication flows to web and mobile applications. It automatically integrates with your existing Amplify configuration and allows you to easily add the entire authentication flow to your application. You simply add the component to your app and pass it your Amazon Cognito authentication configuration. You can then customize themes to adjust colors and styling as needed.
- **Amplify Libraries** provide the low-level building blocks for implementing authentication and give you full control over the UI and logic. However, the Amplify Libraries require more work to implement a full end-to-end solution and you must manage resourcing and provisioning yourself.
- **Hosted UI** is a simple drop-in UI for basic sign-in UI components. However, it has limited functionality (only sign-up and sign-in) and you will still need to manage backend integration and additional authentication workflows. For example, you will still need to integrate Amazon Cognito separately with the Amplify CLI as well as set up workflows for password reset, MFA, federation, and more. 

We recommend using the authenticator to quickly set up your UI component and then use the Amplify Libraries to customize the user experience and logic.

### Recap

You should now have a better idea of which integration path will work for your use case for implementing Auth.

[comment]: # (ADD TO RECAP a tie-in to real-world use and application of the topic discussed OR reiterate the benefit. If not applicable delete this comment.)

## Enable sign-up and verify account

In this job you will set up sign in to allow your customers to sign up to your application and then test that this functionality is working. This includes a review of the sign up methods provided by Amplify, the specific user attributes used by Amazon Cognito, and how to verify users (if needed for your use case). 

> **Before you begin, you will need:**
> - A front-end app
> - Set up and connected backend resources with a configured Auth category 
> - Decided your Auth implementation path
